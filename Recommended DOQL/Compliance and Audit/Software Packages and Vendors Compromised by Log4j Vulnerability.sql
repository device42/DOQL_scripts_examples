/* 0-day query
Approach is via the software and vendors
*/

With
vendor_data as (
Select * From view_vendor_v1 vnd
Where (
vnd.name Like '%Apache%' Or 
vnd.name Like '%Apereo%' Or
vnd.name Like '%Aptible%' Or
vnd.name Like '%Atlassian%' Or
vnd.name Like '%Amazon%' Or
vnd.name Like '%Azure%' Or
vnd.name Like '%Akamai%' Or
vnd.name Like '%Bitnami%' Or
vnd.name Like '%Broadcom%' Or
vnd.name Like '%Carbon Black%' Or
vnd.name Like '%Cisco%' Or
vnd.name Like '%CIS-CAT%' Or
vnd.name Like '%Citrix%' Or
vnd.name Like '%Cloudflare%' Or
vnd.name Like '%cPanel%' Or
vnd.name Like '%Commvault%' Or
vnd.name Like '%Connect2id%' Or
vnd.name Like '%Connectwise%' Or
vnd.name Like '%Contrast%' Or
vnd.name Like '%Coralogix%' Or
vnd.name Like '%Couchbase%' Or
vnd.name Like '%DatadogHQ%' Or
vnd.name Like '%Debian%' Or
vnd.name Like '%Dell%' Or
vnd.name Like '%Dynatrace%' Or
vnd.name Like '%Elastic%' Or
vnd.name Like '%Esri%' Or
vnd.name Like '%Exact%' Or
vnd.name Like '%Forcepoint%' Or
vnd.name Like '%ForgeRock%' Or
vnd.name Like '%F-Secure%' Or
vnd.name Like '%Fortinet%' Or
vnd.name Like '%Genesys%' Or
vnd.name Like '%GoAnywhere%' Or
vnd.name Like '%Graylog%' Or
vnd.name Like '%HCL Software%' Or
vnd.name Like '%Huawei%' Or
vnd.name Like '%IBM%' Or
vnd.name Like '%Informatica%' Or
vnd.name Like '%Jamf Nation%' Or
vnd.name Like '%Jazz/IBM%' Or
vnd.name Like '%JetBrains%' Or
vnd.name Like '%Jitsi%' Or
vnd.name Like '%Kaseya%' Or
vnd.name Like '%Lightbend%' Or
vnd.name Like '%Mailcow%' Or
vnd.name Like '%ManageEngine%' Or
vnd.name Like '%McAfee%' Or
vnd.name Like '%Metabase%' Or
vnd.name Like '%Minecraft%' Or
vnd.name Like '%MongoDB%' Or
vnd.name Like '%N-able%' Or
vnd.name Like '%Nelson%' Or
vnd.name Like '%NetApp%' Or
vnd.name Like '%Netflix%' Or
vnd.name Like '%New Relic%' Or
vnd.name Like '%NSA%' Or
vnd.name Like '%Nutanix%' Or
vnd.name Like '%Okta%' Or
vnd.name Like '%OpenMRS%' Or
vnd.name Like '%OpenNMS%' Or
vnd.name Like '%OpenSearch%' Or
vnd.name Like '%Oracle%' Or
vnd.name Like '%openHAB%' Or
vnd.name Like '%OWASP%' Or
vnd.name Like '%Progress%' Or
vnd.name Like '%Puppet%' Or
vnd.name Like '%QlikTech International%' Or
vnd.name Like '%QOS.ch%' Or
vnd.name Like '%Red Hat%' Or
vnd.name Like '%Safe%' Or
vnd.name Like '%SonicWall%' Or
vnd.name Like '%Sophos%' Or
vnd.name Like '%Splunk%' Or
vnd.name Like '%Stardog%' Or
vnd.name Like '%Ubiquiti%' Or
vnd.name Like '%USoft%' Or
vnd.name Like '%Veeam%' Or
vnd.name Like '%VMware%' Or
vnd.name Like '%WitFoo%' Or
vnd.name Like '%Wowza%')
),
/* Get sw based upon the vendor list  */
sw_data as (
Select * From view_software_v1 sw
Where sw.vendor_fk IN (Select vnd.vendor_pk From vendor_data vnd)
OR position('log4j' IN lower(sw.name)) > 0
),
/* Get siu based upon the vendor list  */
siu_data as (
Select * From view_softwareinuse_v1 siu
Where siu.software_fk IN (Select sw.software_pk From sw_data sw)
)
/* Report out */

Select  Distinct vnd.name "Vendor", sw.name "Software", siu.version "Version", siu.alias_name "Alias", dev.name "Host", siu.first_detected "First Detected", siu.last_updated "Last Updated" 
	From siu_data siu
    Left Join view_software_v1 sw ON sw.software_pk = siu.software_fk
	Left Join view_device_v2 dev ON dev.device_pk = siu.device_fk
	Left Join view_vendor_v1 vnd ON vnd.vendor_pk = sw.vendor_fk
  Order by 1, 2, 3, 4, 5