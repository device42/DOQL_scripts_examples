/* Software Vulnerbility counts of device per vulndb
  01/12/21
*/
 /*  Inline view of target data required (CTE - Common Table Expression) 
  Get target data       
 */
 With target_device_data  as (
	Select Distinct
		swv.softwarevulnerability_pk
		,swv.software_fk
		,swv.software_name
		,swv.vulnerability_id
		,swv.description
		,swv.solution
		,swv.version swv_version
		,swv.score
		,siu.softwareinuse_pk
		,siu.device_fk
		,siu.version siu_version
		,dev.device_pk
		,dev.name
		,concat(swv.softwarevulnerability_pk,'|',swv.version) unique_vulndb		
	From 
		view_softwarevulnerability_v1 swv
	Left Join view_softwareinuse_v1 siu ON siu.software_fk = swv.software_fk
	Join view_device_v2 dev ON dev.device_pk = siu.device_fk
	Where swv.version = siu.version and swv.score >= 7	
	),
	target_count_data  as (
	Select 
	   tdd.device_pk
	   ,tdd.unique_vulndb
	   ,tdd.name
	   ,tdd.vulnerability_id
	From target_device_data tdd
	)
	/* # of devices per vulndb   */		
	Select 
	tcd.vulnerability_id
	,count(*) as device_count
	From target_count_data tcd
	group by 1	
