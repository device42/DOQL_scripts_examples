/* Software Vulnerbility Counts
  01/12/21
*/
 /*  Inline view of target data required (CTE - Common Table Expression) 
  Get target data       
 */
 With target_device_data  as (
	Select Distinct
		swv.softwarevulnerability_pk
		,swv.software_fk
		,swv.software_name
		,swv.vulnerability_id
		,swv.description
		,swv.solution
		,swv.version swv_version
		,swv.score
		,siu.softwareinuse_pk
		,siu.device_fk
		,siu.version siu_version
		,dev.device_pk
		,dev.name
		,concat(swv.softwarevulnerability_pk,'|',swv.version) unique_vulndb		
	From 
		view_softwarevulnerability_v1 swv
	Left Join view_softwareinuse_v1 siu ON siu.software_fk = swv.software_fk
	Join view_device_v2 dev ON dev.device_pk = siu.device_fk
	Where swv.version = siu.version and swv.score >= 7	
	),
	target_count_data  as (
	Select 
	   tdd.device_pk
	   ,tdd.unique_vulndb
	From target_device_data tdd
	),
	/* # of vulndbs per device  */
	target_stat_data_1  as (	
	Select 
	tcd.device_pk
	,count(*) as vulndb_count
	From target_count_data tcd
	group by 1	
	),
	/* # of devices per vulndb   */	
	target_stat_data_2  as (	
	Select 
	tcd.unique_vulndb
	,count(*) as device_count
	From target_count_data tcd
	group by 1	
	)	
	 Select 
	    count (*) total_vulndb 
		,count(Distinct 
			tcd.unique_vulndb) number_vulndb
		,count(Distinct 
			tcd.device_pk) number_devices
		,(Select min(tsd.device_count) From target_stat_data_2 tsd) min_devices
		,(Select max(tsd.device_count) From target_stat_data_2 tsd) max_devices
		,round((Select avg(tsd.device_count) From target_stat_data_2 tsd), 0) avg_devices
		,(Select min(tsd.vulndb_count) From target_stat_data_1 tsd) min_vulndb
		,(Select max(tsd.vulndb_count) From target_stat_data_1 tsd) max_vulndb
		,round((Select avg(tsd.vulndb_count) From target_stat_data_1 tsd), 0) avg_vulndb			
	From target_count_data tcd